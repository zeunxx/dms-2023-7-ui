<html>
    <head>
        <title>Flask-Simple-Chat</title>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket;
           $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                
                socket.on('status', function(data) {
                    // $('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                    const div = document.getElementById('chat_img');
                    div.append('<' + data.msg + '>');
                    $('#chat_img').scrollTop($('#chat_img')[0].scrollHeight);
                });
                socket.on('message', function(data) {
                    //$('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                    const div = document.getElementById('chat_img');
                    div.append('<' + data.msg + '>');
                    $('#chat_img').scrollTop($('#chat_img')[0].scrollHeight);
                });
            });

            // ìœ ì €ê°€ ì‘ì„±í•œ ì´ë¯¸ì§€ ë„ìš°ê¸°
            $(document).ready(function() {

                // ìœ ì €ê°€ ì‘ì„± ë²„íŠ¼ ëˆ„ë¥¸ ì‹œê° 
                var today = new Date(); 

                var month = ('0' + (today.getMonth() + 1)).slice(-2);
                var day = ('0' + today.getDate()).slice(-2);
                var dateString = month  + '/' + day;  

                var hours = ('0' + today.getHours()).slice(-2); 
                var minutes = ('0' + today.getMinutes()).slice(-2);
                var timeString = hours + ':' + minutes;



                var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');
                function updateImage(imageUrl) {
                    $('#chat_img').append('<br>  <img src="'+imageUrl+'"width="100px" height="100px" >' + " ("+dateString+ " "+ timeString+")")


                }
    
                // WebSocket ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•˜ì—¬ ì´ë¯¸ì§€ URLì„ ì—…ë°ì´íŠ¸
                socket.on('image', function(data) {
                    var imageUrl = data.image_url;
                    updateImage(imageUrl);

                    const div = document.getElementById('chat_img');
                    if (div.scrollHeight > div.offsetHeight) {
                        var firstMessage = div.querySelector('p');
                        div.removeChild(firstMessage);
                      }
                  
                      // ìŠ¤í¬ë¡¤ ì¡°ì‘
                    div.scrollTop = div.scrollHeight;
                }, namespace='/test');
            });


            // kafka producerì„œë²„ì— ìœ ì €ê°€ ì‘ì„±í•œ ë©”ì‹œì§€ ì „ì†¡
            function msg_send(){

                // ìœ ì €ê°€ ì‘ì„± ë²„íŠ¼ ëˆ„ë¥¸ ì‹œê° 
                var today = new Date(); 

                var month = ('0' + (today.getMonth() + 1)).slice(-2);
                var day = ('0' + today.getDate()).slice(-2);
                var dateString = month  + '/' + day;  

                var hours = ('0' + today.getHours()).slice(-2); 
                var minutes = ('0' + today.getMinutes()).slice(-2);
                var timeString = hours + ':' + minutes;

                // ìœ ì €ê°€ ì‘ì„±í•œ text 
                const text = document.getElementById('text').value;
                
                // kafka ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡

                const response = fetch("http://3.135.130.17:8989/msg_send", {

                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        writer:"{{name}}",
                        timestamp:String(dateString)+" "+String(timeString),
                        content:String(text)
                    }),
                  })
        
                return response.then(res=>res.json());
        
            }
            async function exec(){
                var text;
                try{
                    text = await msg_send();
                    console.log(text[0].content);
                }catch(error){
                    console.log("################# ì—ëŸ¬!!!!!!!!!!!!",error);
                }
            }

            // kafka producerì„œë²„ì— ìœ ì €ê°€ ì‘ì„±í•œ ì´ë¯¸ì§€ ì „ì†¡
            async function img_send(){
                var file = $('#imageFile')[0].files[0];
                

                if (!file) {
                    alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
               
                
                const formData = new FormData();
                formData.append('image', file);
               
                
                try {
                    const response = await fetch('http://3.135.130.17:8989/img_send', {  
                        method: 'POST',
                        body: formData
                    });
                
                    if (response.ok) {
                        alert('ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    } catch (error) {
                    console.error(error);
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                } 
   
            }
        


            // kafka consumer ì„œë²„ì— ìœ ì €ê°€ ì‘ì„±í•œ ë©”ì‹œì§€ ë°›ì•„ì˜¤ê¸°
            $(document).ready(function() {
                var socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
    
                socket.on('text', (data) => {
                    // ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì„œ divì— ì¶”ê°€
                    const div = document.getElementById('chat_img');
                    div.innerHTML += `<br>${data.writer} : ${data.content}  (${data.timestamp})`;

                    if (div.scrollHeight > div.offsetHeight) {
                        var firstMessage = div.querySelector('p');
                        div.removeChild(firstMessage);
                      }
                  
                      // ìŠ¤í¬ë¡¤ ì¡°ì‘
                      div.scrollTop = div.scrollHeight;
                });
                
            });


            // ìœ ì €ê°€ ë°© ë‚˜ê°
            function leave_room() {
                console.log("#################### ë‚˜ê°")
                socket.emit('left', {}, function() {
                    socket.disconnect();

                    // go back to the login page
                    window.location.href = "{{ url_for('main.index') }}";
                });
            }
        </script>
    </head>
    <body>
        <h1>Chat Room: {{ room }}</h1>
        <h3>DMS 7 team <a href="#" onclick="leave_room();">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</a> </h3>  
       
        <div id="chat_img" style="border:1px solid; width:700px; height:400px;" ></div>
        
        {{ name }} <input id="text" size="80" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”!"> 
        <button onclick="msg_send();">ì „ì†¡</button>   <br><br>

        
        <div class="button">
            <label for="chooseFile">
                ğŸ‘‰ send image ğŸ‘ˆ
            </label>
        </div>
        <input type="file" id="imageFile" accept="image/*">
        
        <button class="submitButton" id="submitButton" onclick="img_send();">ì „ì†¡</button>

        

    </body>
</html>

